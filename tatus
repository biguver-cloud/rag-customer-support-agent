[1mdiff --git a/README.md b/README.md[m
[1mindex 4cb1a0a..e69de29 100644[m
[1m--- a/README.md[m
[1m+++ b/README.md[m
[36m@@ -1 +0,0 @@[m
[31m-# rag-customer-support-agent[m
\ No newline at end of file[m
[1mdiff --git a/app.py b/app.py[m
[1mindex 0a6a232..f6d44e9 100644[m
[1m--- a/app.py[m
[1m+++ b/app.py[m
[36m@@ -12,6 +12,17 @@[m [mfrom rag.agent import agent_answer[m
 from rag.ui import render_citations, render_contact_guidance[m
 [m
 [m
[32m+[m[32m@st.cache_resource(show_spinner=False)[m
[32m+[m[32mdef get_db(persist_dir: Path):[m
[32m+[m[32m    # persist_dir ã¯ Path ã®ã¾ã¾ã§OKï¼ˆå†…éƒ¨ã§ str åŒ–ã•ã‚Œã¦ã‚‚ã‚ˆã„ï¼‰[m
[32m+[m[32m    return open_vectorstore(persist_dir)[m
[32m+[m
[32m+[m
[32m+[m[32m@st.cache_resource(show_spinner=False)[m
[32m+[m[32mdef get_llm():[m
[32m+[m[32m    return ChatOpenAI(model=MODEL_NAME, temperature=TEMPERATURE)[m
[32m+[m
[32m+[m
 def build_followup_questions(user_text: str) -> str:[m
     return f"""è³‡æ–™ã ã‘ã§ã¯ç‰¹å®šã§ãã¾ã›ã‚“ã§ã—ãŸã€‚æ¬¡ã®ã©ã‚Œã«è¿‘ã„ã§ã™ã‹ï¼Ÿ[m
 [m
[36m@@ -37,6 +48,7 @@[m [mdef main():[m
     persist_dir = base_dir / "storage" / "chroma"[m
     user_icon_path = str(base_dir / "images" / "User_ã‚¢ã‚¤ã‚³ãƒ³.png")[m
     ai_icon_path = str(base_dir / "images" / "AI_ã‚¢ã‚¤ã‚³ãƒ³.png")[m
[32m+[m
     if not persist_dir.exists():[m
         st.error("ãƒ™ã‚¯ãƒˆãƒ«DBãŒã‚ã‚Šã¾ã›ã‚“ã€‚å…ˆã« `python build_index.py` ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚")[m
         st.stop()[m
[36m@@ -55,10 +67,13 @@[m [mdef main():[m
     st.success("ã“ã¡ã‚‰ã¯å¼Šç¤¾ã«é–¢ã™ã‚‹è³ªå•ã«ãŠç­”ãˆã™ã‚‹ç”ŸæˆAIãƒãƒ£ãƒƒãƒˆãƒœãƒƒãƒˆã§ã™ã€‚AIã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®åˆ©ç”¨æœ‰ç„¡ã‚’é¸æŠã—ã€ç”»é¢ä¸‹éƒ¨ã®ãƒãƒ£ãƒƒãƒˆæ¬„ã‹ã‚‰è³ªå•ã—ã¦ãã ã•ã„ã€‚")[m
     st.warning("å…·ä½“çš„ã«å…¥åŠ›ã—ãŸã»ã†ãŒæœŸå¾…é€šã‚Šã®å›ç­”ã‚’å¾—ã‚„ã™ã„ã§ã™ã€‚")[m
 [m
[31m-    # ãƒãƒ£ãƒƒãƒˆå±¥æ­´[m
[32m+[m[32m    # ãƒãƒ£ãƒƒãƒˆå±¥æ­´ï¼ˆç„¡åˆ¶é™ã«å¢—ãˆã‚‹ã¨ãƒ¡ãƒ¢ãƒªã‚’é£Ÿã†ã®ã§ä¸Šé™ã‚’ã¤ã‘ã‚‹ï¼‰[m
[32m+[m[32m    MAX_MESSAGES = 20[m
     if "messages" not in st.session_state:[m
         st.session_state.messages = [][m
[31m-    for m in st.session_state.messages:[m
[32m+[m
[32m+[m[32m    # è¡¨ç¤ºã¯ç›´è¿‘ã ã‘[m
[32m+[m[32m    for m in st.session_state.messages[-MAX_MESSAGES:]:[m
         with st.chat_message(m["role"], avatar=user_icon_path if m["role"] == "user" else ai_icon_path):[m
             st.markdown(m["content"])[m
 [m
[36m@@ -67,32 +82,25 @@[m [mdef main():[m
         return[m
 [m
     st.session_state.messages.append({"role": "user", "content": user_text})[m
[32m+[m[32m    st.session_state.messages = st.session_state.messages[-MAX_MESSAGES:]  # ã“ã“ãŒé‡è¦[m
[32m+[m
     with st.chat_message("user", avatar=user_icon_path):[m
         st.markdown(user_text)[m
 [m
     with st.chat_message("assistant", avatar=ai_icon_path):[m
         with st.spinner("PDFã‹ã‚‰æ¤œç´¢ã—ã¦å›ç­”ä¸­..."):[m
[31m-            db = open_vectorstore(persist_dir)[m
[32m+[m[32m            # æ¯å›ãƒ­ãƒ¼ãƒ‰ã—ãªã„ï¼ˆã“ã“ãŒä¸€ç•ªåŠ¹ãï¼‰[m
[32m+[m[32m            db = get_db(persist_dir)[m
 [m
             search_query = rewrite_query_for_search(user_text)[m
             category = guess_category(user_text)[m
 [m
[31m-            context, citations, best_score = retrieve_with_score(db, search_query, k=TOP_K, category=category)[m
[31m-[m
[31m-            # ãƒ‡ãƒãƒƒã‚°æƒ…å ±ã®è¡¨ç¤º[m
[31m-            with st.expander("ğŸ” ãƒ‡ãƒãƒƒã‚°æƒ…å ±"):[m
[31m-                st.write(f"å…ƒã®è³ªå•: {user_text}")[m
[31m-                st.write(f"æ”¹å†™å¾Œã‚¯ã‚¨ãƒª: {search_query}")[m
[31m-                st.write(f"æ¨æ¸¬ã‚«ãƒ†ã‚´ãƒª: {category}")[m
[31m-                st.write(f"å–å¾—ã‚¹ã‚³ã‚¢: {best_score}")[m
[31m-                st.write(f"ã‚¹ã‚³ã‚¢é–¾å€¤: {WEAK_SCORE_THRESHOLD}")[m
[31m-                st.write(f"ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆé•·: {len(context) if context else 0}")[m
[31m-                st.write(f"å¼•ç”¨æ•°: {len(citations)}")[m
[31m-                if context:[m
[31m-                    st.write("**å–å¾—ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆï¼ˆæœ€åˆã®500æ–‡å­—ï¼‰:**")[m
[31m-                    st.code(context[:500])[m
[32m+[m[32m            context, citations, best_score = retrieve_with_score([m
[32m+[m[32m                db, search_query, k=TOP_K, category=category[m
[32m+[m[32m            )[m
 [m
[31m-            llm = ChatOpenAI(model=MODEL_NAME, temperature=TEMPERATURE)[m
[32m+[m[32m            # LLM ã‚‚æ¯å›ä½œã‚‰ãªã„[m
[32m+[m[32m            llm = get_llm()[m
 [m
             if not context.strip():[m
                 answer = "è³‡æ–™ã«è¨˜è¼‰ãŒã‚ã‚Šã¾ã›ã‚“ã€‚è©²å½“ã™ã‚‹PDFåã‚„ç”¨èªï¼ˆä¾‹ï¼šè§£ç´„ã€è¿”é‡‘ã€è«‹æ±‚ãªã©ï¼‰ã‚’å°‘ã—å…·ä½“çš„ã«æ•™ãˆã¦ãã ã•ã„ã€‚"[m
[36m@@ -129,6 +137,7 @@[m [mdef main():[m
         render_contact_guidance(user_text, citations)[m
 [m
     st.session_state.messages.append({"role": "assistant", "content": answer})[m
[32m+[m[32m    st.session_state.messages = st.session_state.messages[-MAX_MESSAGES:]  # ã“ã“ã‚‚é‡è¦[m
 [m
 [m
 if __name__ == "__main__":[m
[1mdiff --git a/build_index.py b/build_index.py[m
[1mindex ca1e51d..78086f6 100644[m
[1m--- a/build_index.py[m
[1m+++ b/build_index.py[m
[36m@@ -60,7 +60,7 @@[m [mdef main():[m
     # 2) åˆ†å‰²[m
     # ------------------------------------------------------------[m
     splitter = RecursiveCharacterTextSplitter([m
[31m-        chunk_size=500,[m
[32m+[m[32m        chunk_size=1000,[m
         chunk_overlap=100,[m
     )[m
     splits = splitter.split_documents(docs)[m
[1mdiff --git a/storage/chroma/7b6f138f-46c5-4204-b48c-916cbd5704c8/data_level0.bin b/storage/chroma/7b6f138f-46c5-4204-b48c-916cbd5704c8/data_level0.bin[m
[1mindex 1ec8bbf..b2dc815 100644[m
Binary files a/storage/chroma/7b6f138f-46c5-4204-b48c-916cbd5704c8/data_level0.bin and b/storage/chroma/7b6f138f-46c5-4204-b48c-916cbd5704c8/data_level0.bin differ
[1mdiff --git a/storage/chroma/7b6f138f-46c5-4204-b48c-916cbd5704c8/length.bin b/storage/chroma/7b6f138f-46c5-4204-b48c-916cbd5704c8/length.bin[m
[1mindex de0e5a8..c2a081e 100644[m
Binary files a/storage/chroma/7b6f138f-46c5-4204-b48c-916cbd5704c8/length.bin and b/storage/chroma/7b6f138f-46c5-4204-b48c-916cbd5704c8/length.bin differ
[1mdiff --git a/storage/chroma/chroma.sqlite3 b/storage/chroma/chroma.sqlite3[m
[1mindex 92ba744..ad6fc85 100644[m
Binary files a/storage/chroma/chroma.sqlite3 and b/storage/chroma/chroma.sqlite3 differ
